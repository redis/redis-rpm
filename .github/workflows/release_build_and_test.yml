name: Release Build and Test

# This workflow is part of the Redis OSS release automation process.

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to build, may be "unstable" for latest unstable release'
        required: false
      workflow_uuid:
        description: 'Optional UUID to identify this workflow run'
        required: false
      release_type:
        description: 'Type of release to upload (public, internal)'
        required: true

# UUID is used to help automation to identify workflow run in the list of workflow runs.
run-name: "Release Build and Test${{ github.event.inputs.workflow_uuid && format(': {0}', github.event.inputs.workflow_uuid) || '' }}"

jobs:
  prepare-release:
    outputs:
      BUILD_OS: ${{ steps.populate-env-vars.outputs.BUILD_OS }}
      TEST_OS: ${{ steps.populate-env-vars.outputs.TEST_OS }}
    runs-on: ["ubuntu-latest"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Redis Release Archive
        uses: redis-developer/redis-oss-release-automation/.github/actions/validate-redis-release-archive@main
        with:
          release_tag: ${{ github.event.inputs.release_tag }}

      - name: Ensure Release Branch
        id: ensure-branch
        uses: redis-developer/redis-oss-release-automation/.github/actions/ensure-release-branch@main
        with:
          release_tag: ${{ github.event.inputs.release_tag }}
          allow_modify: true
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Redis version
        id: update-version
        uses: ./.github/actions/update-redis-version
        with:
          release_tag: ${{ github.event.inputs.release_tag }}
          release_version_branch: ${{ steps.ensure-branch.outputs.release_version_branch }}
          release_type: ${{ github.event.inputs.release_type }}

      - name: Populate env vars
        id: populate-env-vars
        uses: ./.github/actions/parse-env-file

  build-n-test:
    needs:
      - prepare-release
    uses: ./.github/workflows/build-n-test-all-distros.yml
    with:
      BUILD_OS: ${{ needs.prepare-release.outputs.BUILD_OS }}
      TEST_OS: ${{ needs.prepare-release.outputs.TEST_OS }}
      release_tag: ${{ inputs.release_tag }}

  create-release-handle:
    needs: build-n-test
    runs-on: ubuntu-latest
    steps:
      - name: Create Release Handle
        shell: bash
        run: |
          cat <<RELEASE_HANDLE >result.json
          {
            "release_tag": "${{ github.event.inputs.release_tag }}",
            "run_id": ${{ github.run_id }},
            "workflow_uuid": "${{ github.event.inputs.workflow_uuid }}",
            "release_type": "${{ github.event.inputs.release_type }}"
          }
          RELEASE_HANDLE

      - name: Upload release handle artifact
        uses: actions/upload-artifact@v4
        with:
          name: release_handle
          path: result.json
          retention-days: 90

  # Notify only about build failures
  # as publish workflow will notify about publish success or failure
  slack-failure-notification:
    needs: build-n-test
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect env name
        id: detect-env
        run: |
          if [ "${{ inputs.release_type }}" = "public" ]; then
            env_name="production"
          elif [ "${{ inputs.release_type }}" = "internal" ]; then
            env_name="staging"
          fi
          echo "env_name=$env_name" >> $GITHUB_OUTPUT

      - name: Send Failure Slack notification
        if: vars.SLACK_WEB_HOOK_URL != ''
        uses: ./.github/actions/slack-notification
        with:
          slack_func: slack_format_failure_message
          release_tag: ${{ github.event.inputs.release_tag }}
          env: ${{ steps.detect-env.outputs.env_name }}
          url_prefix: ""
          packages_json: "{}"
          message: ":package: RPM package build failed"
          SLACK_WEB_HOOK_URL: ${{ secrets.SLACK_WEB_HOOK_URL }}

